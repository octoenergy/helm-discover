name: Testing
on: [push]
jobs:
  Test-Downloader-Plugin:
    runs-on: ubuntu-latest
    container: alpine/helm:3.5.4
    env:
      HELM_BIN: helm
      HELM_PLUGIN_DIR: .
      TEST_SCRIPT: |-
        result="$(bin/discover . . . "${path}")"
        test "$expected" == "$result" \
        || (echo "Expected:
        ${expected}
        Result:
        ${result}"; return 1)
    steps:
      - name: Check out repository
        uses: actions/checkout@v2
      - name: Establish test config hierarchy
        run: |
          mkdir -p test/dir.yaml
          mkdir -p test/one/dir.txt

          echo a: 1 > test/foo.yaml
          echo b: 2 > test/bar.yml
          echo c: 3 > test/baz.txt
          echo d: 4 > test/one/foo.yaml
          echo e: 5 > test/one/dir.txt/foo.yaml
          echo f: 6 > test/one/fizz.txt
          echo g: 7 > test/dir.yaml/foo.enc

      - name: Test default behaviour
        env:
          path: discover://test
          expected: |-
            a: 1
            b: 2
        run: sh -c "${TEST_SCRIPT}"

      - name: Test recursive behaviour
        env:
          path: discover://test?recursive
          expected: |-
            a: 1
            b: 2
            d: 4
            e: 5
        run: sh -c "${TEST_SCRIPT}"

      - name: Test suffix behaviour
        env:
          path: discover://test?suffix=.txt
          expected: |-
            c: 3
        run: sh -c "${TEST_SCRIPT}"

      - name: Test recursive and suffix behaviour
        env:
          path: discover://test?recursive&suffix=.txt
          expected: |-
            c: 3
            f: 6
        run: sh -c "${TEST_SCRIPT}"

      - name: Test prefix and suffix behaviour
        env:
          path: discover://test?suffix=.txt&prefix=b
          expected: |-
            c: 3
        run: sh -c "${TEST_SCRIPT}"

      - name: Test unioned prefix and suffix behaviour
        env:
          path: discover://test?suffix=.txt&prefix=b&union
          expected: |-
            b: 2
            c: 3
        run: sh -c "${TEST_SCRIPT}"

      - name: Test recursive prefix and suffix behaviour
        env:
          path: discover://test?suffix=.txt&prefix=f&recursive
          expected: |-
            f: 6
        run: sh -c "${TEST_SCRIPT}"

      - name: Test recursive unioned prefix and suffix behaviour
        env:
          path: discover://test?union&suffix=.txt&prefix=f&recursive
          expected: |-
            a: 1
            c: 3
            d: 4
            e: 5
            f: 6
            g: 7
        run: sh -c "${TEST_SCRIPT}"
